@{ ViewData["Title"] = "UploadImage";
}

@model CTB.DomainModel.HappyHandingIn.HHIModel.AssignedTaskModel

<script src="~/js/jquery.min.js"></script>

<script type="text/html" id="template-card">
    <div class="card text-center">
        <img id="img-new" src="..." class="card-img-top">
        <div class="card-body">
            <h5 id="img-new-index" class="card-title">...</h5>
            <p id="img-new-type" class="card-text">...</p>
            <p id="img-new-qul" class="card-text">...</p>
            <button class="btn btn-outline-secondary" type="button" onclick="Remove(this)">移除</button>
        </div>
    </div>
</script>

<script type="text/javascript">
    function doUpload() {
        var formData = new FormData();
        var cards = document.getElementById("img-card-group").childNodes;
        var index = 0;
        for (var i = 0; i < cards.length; i++) {
            if (cards[i].nodeName == "#text") {
                continue;
            }
            formData.append(index.toString(), cards[i].childNodes[1].src.toString());
            index++;
        }
        if (index == 0) { 
            alert("请添加至少一张图片");
            return;
        }
        if (window.confirm('请确保正在提交的作业和需要提交的照片\n确认开始提交？')) {
            formData.append("image-count", index.toString());
            $.ajax({
                url: '@Url.Action("FileSave")',
                type: 'POST',
                data: formData,
                async: true,
                cache: false,
                contentType: false,
                processData: false,
                success: function (returndata) {
                    document.getElementById("link-success").click();
                    // alert(returndata);
                },
                error: function (returndata) {
                    alert("上传失败，请重试。");
                }
            });
        } else {
            return;
        }
    }
    var total = 0;
    var imgQuality = 0.8;
    var imgType = "image/jpeg";
    function Remove(obj) {
        if (window.confirm('确认移除？')) {

            var cards = document.getElementById("img-card-group").childNodes;
            document.getElementById("img-card-group").removeChild(obj.parentNode.parentNode);
            // Rearrange the card titles.
            total = 0;
            for (var i = 0; i < cards.length; i++) {
                if (cards[i].nodeName == "#text") {
                    continue;
                }
                cards[i].childNodes[3].childNodes[1].innerHTML = "第 " + total.toString() + " 张";
                total++;
            }
        }
    }
    function GetImageQuality(action) {
        var radionum = document.getElementById("id-radios-qul").childNodes;
        for (var i = 0; i < radionum.length; i++) {
            if (radionum[i].nodeName == "#text") {
                continue;
            }
            for (var j = 0; j < radionum[i].childNodes.length; j++) {
                if (radionum[i].childNodes[j].nodeName =="INPUT") {
                    if (radionum[i].childNodes[j].checked) {
                        imgQuality = radionum[i].childNodes[j].value;
                        return;
                    }
                }
            }
        }
    }
    function GetImageType(action) {
        var radionum = document.getElementById("id-radios-type").childNodes;
        for (var i = 0; i < radionum.length; i++) {
            if (radionum[i].nodeName == "#text") {
                continue;
            }
            for (var j = 0; j < radionum[i].childNodes.length; j++) {
                if (radionum[i].childNodes[j].nodeName == "INPUT") {
                    if (radionum[i].childNodes[j].checked) {
                        imgType = radionum[i].childNodes[j].value;
                        return;
                    }
                }
            }
        }
    }
    function RemoveAll() {
        if (window.confirm('确认全部清除？')) {
            // Model.IdCardImgs = null;
            total = 0;
            document.getElementById("img-card-group").innerHTML = "";
            document.getElementById("picker").value = "";
        }
    }
    var loadImageFile = function () {
        var uploadImage = document.getElementById("picker");
        //check and return the length of uploaded file.
        if (uploadImage.files.length === 0) {
            return;
        }
        for (var i = 0; i < uploadImage.files.length; i++) {
            //Is Used for validate a valid file.
            var filterType = /^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;
            var uploadFile = document.getElementById("picker").files[i];
            if (!filterType.test(uploadFile.type)) {
                alert("请选择一张图片文件");
                return;
            }

            var fileReader = new FileReader();
            fileReader.onload = function (event) {
                var image = new Image();
                image.onload = function () {
                    var max = image.width > image.height ? image.width : image.height;
                    var a = max / 1000;
                    var canvas = document.createElement("canvas");
                    var context = canvas.getContext("2d");
                    canvas.width = image.width / a;
                    canvas.height = image.height / a;
                    context.drawImage(image,
                        0,
                        0,
                        image.width,
                        image.height,
                        0,
                        0,
                        canvas.width,
                        canvas.height
                    );
                    // Create show grid
                    var parent = document.getElementById("img-card-group");
                    parent.innerHTML += document.getElementById("template-card").innerHTML;
                    document.getElementById("img-new-index").innerHTML = "第 " + total.toString() + " 张";
                    document.getElementById("img-new-index").setAttribute("id", total.toString());
                    GetImageQuality();
                    GetImageType();
                    document.getElementById("img-new").src = canvas.toDataURL(imgType, imgQuality);
                    document.getElementById("img-new-type").innerHTML = "图片格式： " + imgType;
                    document.getElementById("img-new-type").setAttribute("id", total.toString());
                    document.getElementById("img-new-qul").innerHTML = "图片质量等级： " + imgQuality;
                    document.getElementById("img-new-qul").setAttribute("id", total.toString());
                    document.getElementById("img-new").setAttribute("id", total.toString());
                    ++total;
                }
                image.src = event.target.result;
            };
            fileReader.readAsDataURL(uploadFile);
        }
    }
</script>
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a>小工具</a></li>
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Utils_HHI" asp-action="Index">快乐交作业</a></li>
        <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
    </ol>
</nav>

<div class="container" style="margin-bottom: 1rem; margin-top: 1rem">
    <fieldset class="form-group">
        <div class="row">
            <legend class="col-form-label col-sm-2 pt-0">图片质量</legend>
            <div id="id-radios-qul" class="col-sm-10">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radio-qul" id="gridRadios1" value="0.8"checked>
                    <label class="form-check-label" for="gridRadios1">
                        原图
                    </label>
                    <span class="badge badge-pill badge-info">推荐</span>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radio-qul" id="gridRadios2" value="0.6">
                    <label class="form-check-label" for="gridRadios2">
                        较快
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radio-qul" id="gridRadios3" value="0.3">
                    <label class="form-check-label" for="gridRadios3">
                        最快
                    </label>
                </div>
            </div>
        </div>
    </fieldset>
    <fieldset class="form-group">
        <div class="row">
            <legend class="col-form-label col-sm-2 pt-0">图片格式</legend>
            <div id="id-radios-type" class="col-sm-10">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radio-type" id="gridRadios4" value="image/jpeg" checked>
                    <label class="form-check-label" for="gridRadios4">
                        JPG
                    </label>
                    <span class="badge badge-pill badge-info">推荐</span>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radio-type" id="gridRadios5" value="image/png">
                    <label class="form-check-label" for="gridRadios5">
                        PNG
                    </label>
                </div>
            </div>
        </div>
    </fieldset>
    <div class="form-group">
        <div class="input-group">
            <div class="custom-file">
                <input type="file" id="picker" onchange="loadImageFile()" multiple="multiple" class="custom-file-input" aria-describedby="inputGroupFileAddon04">
                <label id="img-count" class="custom-file-label" for="inputGroupFile04">添加图片</label>
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="RemoveAll()">移除所有图片</button>
            </div>
        </div>
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>小贴士</strong>
            <br />1.添加完照片后，提交按钮在最底部。
            <br />2.选择的图片质量与格式将作用于选择后添加的图片。
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
    <div class="card-group" id="img-card-group">
    </div>
    <button type="submit" class="btn btn-primary btn-lg btn-block" onclick="doUpload()">提交</button>
</div>
<a asp-area="" id="link-success" asp-controller="Utils_HHI" asp-action="UploadSuccessfully" hidden="hidden"></a>



